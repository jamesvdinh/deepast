<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-segmentation" data-theme="dark" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Tutorial: Segmentation | Deep Past Challenge</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="description" content="A $1,000,000+ machine learning and computer vision competition"><meta data-rh="true" property="og:type" content="website"><meta data-rh="true" property="og:url" content="https://scrollprize.org"><meta data-rh="true" property="og:title" content="Deep Past Challenge"><meta data-rh="true" property="og:description" content="A $1,000,000+ machine learning and computer vision competition"><meta data-rh="true" property="og:image" content="https://scrollprize.org/img/social/opengraph.jpg"><meta data-rh="true" property="twitter:card" content="summary_large_image"><meta data-rh="true" property="twitter:url" content="https://scrollprize.org"><meta data-rh="true" property="twitter:title" content="Deep Past Challenge"><meta data-rh="true" property="twitter:description" content="A $1,000,000+ machine learning and computer vision competition"><meta data-rh="true" property="twitter:image" content="https://scrollprize.org/img/social/opengraph.jpg"><link data-rh="true" rel="icon" href="/deepast/img/social/favicon.ico"><link data-rh="true" rel="canonical" href="https://jamesvdinh.github.io/deepast/segmentation"><link data-rh="true" rel="alternate" href="https://jamesvdinh.github.io/deepast/segmentation" hreflang="en"><link data-rh="true" rel="alternate" href="https://jamesvdinh.github.io/deepast/segmentation" hreflang="x-default"><script src="https://cdn.usefathom.com/script.js" data-site="XERDEBQR" defer="defer" data-spa="auto"></script><link rel="stylesheet" href="/deepast/assets/css/styles.818a908c.css">
<script src="/deepast/assets/js/runtime~main.631ee407.js" defer="defer"></script>
<script src="/deepast/assets/js/main.2a1808c8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/deepast/"><div class="navbar__logo"><img src="/deepast/img/social/favicon-64x64.png" alt="Deep Past Challenge Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/deepast/img/social/favicon-64x64.png" alt="Deep Past Challenge Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Deep Past Challenge</b></a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col"><div class="docItemContainer_Djhp"><article><div class="theme-doc-markdown markdown"><header><h1>Tutorial: Segmentation</h1></header>
<p><em>Last updated: February 20, 2025</em></p>
<p>This tutorial is a practical walkthrough for two of the methods reviewed in the <a href="/deepast/unwrapping">virtual unwrapping guide</a>. Both of these methods are in active development and as such the content of this page may become outdated (let us know so we can fix it!). For a high-level introduction to the problem these approaches are aiming to solve, check out that <a href="/deepast/unwrapping">guide</a>.</p>
<p>Both of these methods have pros and cons detailed in the previous walkthrough, in terms of current and future performance. Currently implemented, the primary benefit of the VC3D tracer solution is that the intermediate steps produce immediately usable partial segments, and the entire pipeline save ink detection is self-contained within the VC3D ecosystem. <em>If you are looking to simply produce exploratory segments for ink detection or other tasks, the tracer has the lowest &quot;startup&quot; time.</em></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you want to try out running traces only, and do not want to perform any of the seeding or expansion steps, you can download patches we have generated for some of the scrolls from the links in the <a href="#volume-data">data section</a>, place these in your paths directory, place the uint8 volumes and surface predictions in the volume directory, and skip to <a href="#running-a-trace">running a trace</a>.</p></div></div>
<!-- -->
<p><strong>Table of Contents</strong></p>
<div class="tableOfContentsInline_prmo"><ul class="table-of-contents"><li><a href="#sheet-tracing-vc3d">Sheet Tracing (VC3D)</a><ul><li><a href="#installation">Installation</a></li><li><a href="#preparing-data">Preparing Data</a><ul><li><a href="#volume-data">Volume Data</a></li></ul></li><li><a href="#seeding-the-volume">Seeding the Volume</a></li><li><a href="#expanding-seeds">Expanding Seeds</a></li><li><a href="#running-a-trace">Running a Trace</a></li><li><a href="#fixing-errors">Fixing Errors</a></li><li><a href="#inpainting">Inpainting</a></li><li><a href="#rendering">Rendering</a></li><li><a href="#ink-detection">Ink Detection</a></li><li><a href="#common-issues">Common Issues</a></li><li><a href="#tips-and-tricks">Tips and Tricks</a></li></ul></li><li><a href="#spiral-fitting-coming-soon">Spiral Fitting (Coming Soon)</a></li></ul></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sheet-tracing-vc3d">Sheet Tracing (VC3D)<a href="#sheet-tracing-vc3d" class="hash-link" aria-label="Direct link to Sheet Tracing (VC3D)" title="Direct link to Sheet Tracing (VC3D)">​</a></h2>
<div class="mb-4"><img src="/img/segmentation/vc3d_gui.png" class="w-[85%]"></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h3>
<p>This guide will be written for Ubuntu 24.04, for other operating systems the details may vary slightly. Windows users may benefit from using Windows Subsystem For Linux(WSL2), and placing their volume data within the Linux filesystem.</p>
<p><strong>Install Docker Engine for Linux:</strong></p>
<p>Follow the installation steps <a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Ensure your installation is complete by entering. If you get the &#x27;hello world&#x27; output from Docker, you&#x27;re good to go.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo docker run hello-world</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Pull the container image</strong></p>
<p>While it is possible to build this from source, we recommend just pulling the container image from our <a href="https://github.com/ScrollPrize/volume-cartographer" target="_blank" rel="noopener noreferrer">volume-cartographer repository</a> by entering the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo docker pull ghcr.io/scrollprize/volume-cartographer:edge</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Launch VC3D</strong></p>
<p>To launch the docker image, simply type</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">xhost +local:docker</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo docker run -it --rm \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -v &quot;/path/to/data/:/path/to/data/&quot; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -v /tmp/.X11-unix:/tmp/.X11-unix \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -e DISPLAY=$DISPLAY \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -e QT_QPA_PLATFORM=xcb \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -e QT_X11_NO_MITSHM=1 \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ghcr.io/scrollprize/volume-cartographer:edge</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The -v flag is used to mount a folder to the docker image, allowing you to use files that exist on your local filesystem. It will be mounted under the path following the &#x27;:&#x27;. You can place as many folders here as you would like.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you map the docker path exactly the same as it exists on your local system, you can use command snippets in either place without modification. This will also <em>greatly</em> help troubleshooting path issues.</p></div></div>
<p>You&#x27;ll now have a terminal open in the running Docker container. To open the GUI type</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">OMP_NUM_THREADS=8 OMP_WAIT_POLICY=PASSIVE OMP_NESTED=FALSE nice ionice VC3D</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that while the OMP environment variables and <code>nice ionice</code> are not necessary, for now these will make VC3D more responsive when working with very large amounts of patches.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-data">Preparing Data<a href="#preparing-data" class="hash-link" aria-label="Direct link to Preparing Data" title="Direct link to Preparing Data">​</a></h3>
<p>VC3D requires a few changes to the data you may already have downloaded. All data must be in OME-Zarr format, of dtype uint8, and contain a meta.json file. To check if your zarr is in uint8 already, open a resolution group zarray file (located at /path/to.zarr/0/.zarray) look at the dtype field. &quot;|u1&quot; is uint8, and &quot;|u2&quot; is uint16.</p>
<p>The meta.json contains the following information. The only real change from a standard VC meta.json is the inclusion of the <code>format:&quot;zarr&quot;</code> key.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;height&quot;</span><span class="token operator">:</span><span class="token number">3550</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;max&quot;</span><span class="token operator">:</span><span class="token number">65535.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;min&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;PHerc0332, 7.91 - zarr - s3_raw&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;slices&quot;</span><span class="token operator">:</span><span class="token number">9778</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;vol&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;20231117143551-zarr-s3_raw&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;voxelsize&quot;</span><span class="token operator">:</span><span class="token number">7.91</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token property">&quot;width&quot;</span><span class="token operator">:</span><span class="token number">3400</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;format&quot;</span><span class="token operator">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;zarr&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To convert an already downloaded Zarr of dtype uint16 to uint8, download the zarr_to_ome.py file located in @khartes_chuck&#x27;s scroll2zarr repository <a href="https://github.com/KhartesViewer/scroll2zarr" target="_blank" rel="noopener noreferrer">here</a> and use the following command</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">python zarr_to_ome.py /path/to/input.zarr /path/to/output.zarr --bytes 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>if you are performing this on &quot;indicator&quot; data (such as binary predictions), use the flag <code>--algorithm max</code> or <code>--algorithm nearest</code>. When downsampling with the default &#x27;mean&#x27; algorithm, the values of the neighboring pixels are considered when writing the lower resolution array. If we have a pixel of value 255, and the pixels around it are mostly valued 0, we might get a pixel of value 125. This obviously is not desired.</p></div></div>
<p>If you do not wish to perform these, you can use the standardized volumes, links are below for these. I&#x27;d recommend Scroll 3 if you are looking to conserve storage, as it&#x27;s only around 100gb all-in.</p>
<p>If you want to use the original data and do not want to run the processing steps, we have converted some of the scrolls into uint8 and placed the meta.json files within. These links will be updated as new predictions become available. You do not need both versions, you only need one version of the volume data.</p>
<p>The data should be placed within the volpkg of the respective scroll, in this format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── scroll1.volpkg/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── volumes/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │   ├── s1_uint8_ome.zarr -- this is your volume data/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │   │   └── meta.json - REQUIRED!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │   └── 050_entire_scroll1_ome.zarr -- this is your surface prediction/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │       └── meta.json - REQUIRED!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── paths </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    └── config.json - REQUIRED!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="volume-data">Volume Data<a href="#volume-data" class="hash-link" aria-label="Direct link to Volume Data" title="Direct link to Volume Data">​</a></h4>
<ul>
<li>Scroll 1<!-- -->
<ul>
<li>Raw uint8 not yet available, in progress.</li>
<li><a href="https://dl.ash2txt.org/full-scrolls/Scroll1/PHercParis4.volpkg/volumes_zarr_standardized/" target="_blank" rel="noopener noreferrer">Standardized</a></li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s1/surfaces/full_scroll/050_entire_scroll1_ome.zarr.zip" target="_blank" rel="noopener noreferrer">Surface Predictions</a> - Updated 29 Dec 2024</li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s1/s1_patches.7z" target="_blank" rel="noopener noreferrer">Patches</a> - Updated 02 Feb 2025</li>
</ul>
</li>
<li>Scroll 2 - Not available<!-- -->
<ul>
<li><a href="https://dl.ash2txt.org/full-scrolls/Scroll2/PHercParis3.volpkg/volumes_zarr_standardized/" target="_blank" rel="noopener noreferrer">Standardized</a></li>
</ul>
</li>
<li>Scroll 3<!-- -->
<ul>
<li>Raw uint8 not yet available, in progress.</li>
<li><a href="https://dl.ash2txt.org/full-scrolls/Scroll3/PHerc332.volpkg/volumes_zarr_standardized/" target="_blank" rel="noopener noreferrer">Standardized</a></li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s3/surfaces/s3_multi-ensemble_ome.7z" target="_blank" rel="noopener noreferrer">Surface Predictions</a> - Updated 26 Jan 2025</li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s3/s3_patches.7z" target="_blank" rel="noopener noreferrer">Patches</a> - Updated 06 Feb 2025</li>
</ul>
</li>
<li>Scroll 4<!-- -->
<ul>
<li>Raw uint8 not yet available, in progress.</li>
<li>Standardized not yet available, in progress.</li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s4/surfaces/s4_multi-ensemble_ome.7z" target="_blank" rel="noopener noreferrer">Surface Predictions</a> - Updated 28 Jan 2025</li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s4/s4_patches.7z" target="_blank" rel="noopener noreferrer">Patches</a> - Updated 01 Feb 2025</li>
</ul>
</li>
<li>Scroll 5<!-- -->
<ul>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s5/s5_masked_ome.zarr/" target="_blank" rel="noopener noreferrer">Raw uint8</a></li>
<li><a href="https://dl.ash2txt.org/full-scrolls/Scroll5/PHerc172.volpkg/volumes_zarr_standardized/" target="_blank" rel="noopener noreferrer">Standardized</a></li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s5/surfaces/s5_055_surfaces.7z" target="_blank" rel="noopener noreferrer">Surface Predictions</a> - Updated 10 Feb 2025</li>
<li><a href="https://dl.ash2txt.org/community-uploads/bruniss/scrolls/s5/s5_patches.7z" target="_blank" rel="noopener noreferrer">Patches</a> - Updated 09 Feb 2025</li>
</ul>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seeding-the-volume">Seeding the Volume<a href="#seeding-the-volume" class="hash-link" aria-label="Direct link to Seeding the Volume" title="Direct link to Seeding the Volume">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you are running these steps in a docker container that was started using <code>sudo</code>, the files generated during these steps will be owned by root. If you encounter write errors in subsequent steps, change the ownership of the folder by typing</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo chown -R username /path/to/folder</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you encounter &quot;json&quot; errors, its likely you have entered your paths wrong, or forgot to include a meta.json! If you cannot view the zarr within the vc3d gui, you may be missing the <code>format:zarr</code> key!</p></div></div>
<p>Much of this section borrows from Hendrik Schilling&#x27;s repository <a href="https://github.com/hendrikschilling/FASP" target="_blank" rel="noopener noreferrer">here</a>, which also contains more detailed explanations of these processes.</p>
<p>The tracer operates by connecting overlapping patches based on a number of conditions. It chooses the initial candidates to connect based on patch overlap, and then uses some constraints defined within the cost functions to find the optimal patch to select. This step places our initial seeds, which are later expanded. The app that generates the seeds and the expanded patches is <code>vc_grow_seg_from_seed</code>.</p>
<p>During the tracing , a euclidean distance transform is performed, and this is stored within a cache, defined in the json params. This can occupy a non-neglible amount of space, so ensure your disk has enough storage -- my Scroll 1 cache is 376gb. This (and each subsequent step) involves <em>a ton</em> of disk i/o , so a very fast disk here is a good choice.</p>
<p>The seed step uses a json file for configuration, which looks like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;cache_root&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/mnt/raid_nvme/scroll3.volpkg/ensemble_cache&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;thread_limit&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;min_area_cm&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;generations&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We begin the volume seeding by entering the following command , replacing the paths with your own.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">time seq 1 5000 |  xargs -i -P 8 bash -c &#x27;nice ionice bin/vc_grow_seg_from_seed /mnt/raid_nvme/volpkgs/scroll3.volpkg/volumes/s3_multi_ensemble_ome.zarr /mnt/raid_nvme/volpkgs/scroll3.volpkg/paths /mnt/raid_nvme/volpkgs/scroll3.volpkg/seed.json&#x27; || true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will run vc_grow_seg_from_seed five thousand times, concurrently using 8 processes. You can change these values if desired. This is ran 5,000 times because each run may not produce a segment that meets our min_area_cm defined in the json. Each time a succesful seed is generated, it will be placed in your /paths/ directory. We&#x27;d like to finish this seeding step with the following counts for seeds:</p>
<ul>
<li>Scroll 1, 2, and 5 (Entire Scroll) - 5,000</li>
<li>Scroll 3 and 4 - 1000-1500</li>
</ul>
<p>You can watch the progress of the seeding by opening another terminal window and entering:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">watch -n 1 &quot;ls -l /path/to/paths | wc -l&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will refresh every 1 second, and count the number of folders in your /paths/ directory.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>You may need to run the seed command multiple times to get a sufficient number of seeds before proceeding to the next step.</p></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expanding-seeds">Expanding Seeds<a href="#expanding-seeds" class="hash-link" aria-label="Direct link to Expanding Seeds" title="Direct link to Expanding Seeds">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Seeds created using the mode &quot;seed&quot; do not contain overlap information and are not used by the tracer. Ensure that your params json &#x27;mode&#x27; key is set to &#x27;expansion&#x27; for this step.</p></div></div>
<p>In this step, each initial seed is visited in an attempt to generate overlapping patches. The new patches will grow out from these initial seeds, and should eventually populate the entire scroll volume. Expansions are generated until each patch has a minimum number of overlapping patches associated with it. Overlaps are marked by creating a symlinked file in the /auto_grown_xxxx/overlaps directory of the respective patch. Expansion mode uses a config json, which contains the following keys:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;mode&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;expansion&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;cache_root&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/mnt/raid_nvme/scroll3.volpkg/ensemble_cache&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;tgt_overlap_count&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;min_area_cm&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.30</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;thread_limit&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;generations&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Begin the expansion step by typing:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">time seq 1 10000000 |  xargs -i -P 8 bash -c &#x27;nice ionice bin/vc_grow_seg_from_seed /mnt/raid_nvme/volpkgs/scroll3.volpkg/volumes/s3_multi_ensemble_ome.zarr /mnt/raid_nvme/volpkgs/scroll3.volpkg/paths /mnt/raid_nvme/volpkgs/scroll3.volpkg/seed.json&#x27; || true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may need to repeat this command, until the volume is densely seeded. The number of patches required is somewhat difficult to approximate as better predictions generate larger patches, which require less seeds. You will need to open vc3d and inspect the volume to see it is sufficiently seeded. As an example, this Scroll 1 volume contains 68,000 seeds and could still use some more.</p>
<div class="mb-4"><img src="/img/segmentation/s1_seeded.png" class="w-[50%]"><figcaption class="mt-[-6px]">Scroll 1 with generated patches.</figcaption></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-a-trace">Running a Trace<a href="#running-a-trace" class="hash-link" aria-label="Direct link to Running a Trace" title="Direct link to Running a Trace">​</a></h3>
<p>A &quot;Trace&quot; in the context of vc3d is essentially the same as a segmentation as we&#x27;ve come to know them.</p>
<p>This step will finally create larger connected surfaces. The large surface tracer generates a single surface by tracing a &quot;consensus&quot; surface from the patches generated earlier. This processed can be influenced by annotating patches in several ways which allows to guide the tracer to avoid errors. Hence the process looks like this:</p>
<ol>
<li>pick a seed patch</li>
<li>generate a trace</li>
<li>check for errors</li>
<li>annotation</li>
<li>and repeat step 2-4 or 1-4 several times</li>
</ol>
<p>Keep previous trace rounds around as the fusion step can later join multiple traces and problematic areas of a trace can be masked out. A mask can be generated for example with VC3D, or by using any 8-bit grayscale image with the same aspect ratio as one of the tiffxyz channels.</p>
<p><strong>Locate a seed patch</strong>
The choice here is somewhat arbitrary, but the initial condition is important. You want a seed here that does not skip sheets, and is of reasonable size.</p>
<div class="mb-4"><img src="/img/segmentation/s3_good_seed.png" class="w-[100%]"><figcaption class="mt-[-6px]">A &quot;good&quot; seed&quot;.</figcaption></div>
<p>By placing patches generated in the last step into the paths directory of the volpkg VC3D allows to inspect them. VC3D can also display the prediction ome-zarrs, which, together with fiber continuity allows to quickly scan for obvious errors. Useful tools for navigation:</p>
<ul>
<li>ctrl-click in any slice view to focus and slice on the clicked point</li>
<li>shift-click to place a red POI</li>
<li>shift-ctrl-click to place a blur POI</li>
<li>filter by focus point &amp; filter by POIs to narrow down the choice of patches</li>
</ul>
<div class="mb-4"><img src="/img/segmentation/s3_bad_seed.png" class="w-[100%]"><figcaption class="mt-[-6px]">A &quot;bad&quot; seed&quot;.</figcaption></div>
<p><strong>Generate the trace</strong></p>
<p>The trace uses a config json with the following parameters:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;flip_x&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;global_steps_per_window&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;step&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;consensus_default_th&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;consensus_limit_th&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>flip_x determines the direction of the trace (it always grows to the right, but that can go to the inside or outside of the scroll, depending on seed location).</li>
<li>global steps per window: number of global optimization steps per moving window. The tracer operates in a moving window fashion, once the global optimization steps were run per window and no new corners were added the window is moved to the right and the process repeated. At the beginning use 0 global steps to get a fast and long trace and see if there are any coarse errors. Set to 0 to get a purely greedy but quite fast trace.</li>
<li>consensus_default_th: lowest number of inliers (patch &quot;supports&quot;) required per corner to be considered an inlier. Note that a single well-connected patch gives more than a single support to a corner (so this is not the number of surfaces). Maximum of 20 to get only well-connected patches, minimum of 6 before there are a lot of errors. For the submission values of 6 and 10 were used.</li>
<li>consesus_limit_th: if we could otherwise not proceed go down to this number of required inliers, this will only be used if otherwise the trace would end.</li>
</ul>
<p>Begin the trace by typing:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">bin/vc_grow_seg_from_segments /mnt/raid_nvme/volpkgs/scroll3.volpkg/volumes/s3_multi_ensemble_ome.zarr /mnt/raid_nvme/volpkgs/scroll3.volpkg/paths /mnt/raid_nvme/volpkgs/scroll3.volpkg/paths/ /mnt/raid_nvme/volpkgs/scroll3.volpkg/params.json /mnt/raid_nvme/volpkgs/scroll3.volpkg/paths/auto_grown_20250211031737772</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The tracer will generate a debug/preview surface every 50 generations (labeled z_dbg_gen...) and in the end save a final surface, both in the output dir. You can watch the trace grow by opening and closing vc3d to repopulate the segments and selecting the highest number &quot;dbg_gen&quot; to view it in the 2d window in the top left. If the trace starts growing opposite of the direction you intended, change &quot;flip_x&quot; to the opposite of what you had set (for ex: true to false)</p>
<div class="mb-4"><img src="/img/segmentation/s3_sample_trace.png" class="w-[100%]"><figcaption class="mt-[-6px]">Scroll 3 trace &quot;in-progress&quot;.</figcaption></div>
<p><strong>Check for errors</strong></p>
<p>Using the VC3D GUI, the traced surfaces can be inspected for errors. Inspecting with an ome-zarr volume containing the original scan data (to see fiber continuity) is suggested. You can switch your volume by selecting the drop-down below the segments.</p>
<p>The errors that need to be fixed are generally sheet jumps, where the surface jumps from one correct surface to another correct surface. Often these are visible by checking for gaps in the generated trace as a jump will normally not reconnect with the rest of the trace.</p>
<p>Typically, the easiest method for fixing these is to locate where the sheet jump first occurs, and then ctrl+click on this location, filter segments by focus point, and then mask out the offending patches.</p>
<div class="mb-4"><img src="/img/segmentation/sheet_jump.jpg" class="w-[75%]"><figcaption class="mt-[-6px]">&quot;Sheet Jump&quot; in a patch&quot;.</figcaption></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixing-errors">Fixing Errors<a href="#fixing-errors" class="hash-link" aria-label="Direct link to Fixing Errors" title="Direct link to Fixing Errors">​</a></h3>
<p>VC3D allows to annotate patches as approved, defective, and to edit a patch mask which allows masking out areas of a patch that are problematic.</p>
<div class="mb-4"><img src="/img/segmentation/vc3d_annotation.jpg" class="w-[50%]"></div>
<p><strong>Defective</strong></p>
<p>A patch can be marked as &quot;defective&quot; by checking the checkbox in the VC3D side panel. This is fast but not very useful as most patches have some good areas and also will have some amount of errors. Errors only matter if they fall at the same spot in multiple patches, so marking a whole patch as defective, which will make the tracer ignore it completely is not necessary. <strong><em>Use sparingly, most patches contain at least some good data</em></strong></p>
<p><strong>Approved</strong></p>
<p>Checking the approved checkbox will mark a patch as manually &quot;approved&quot; which means the tracer will consider mesh corners coming from such a patch as good without checking for other patches. It is important that such a patch is error free (which is not necessary when creating a mask to only remove a problem area without checking &quot;approved&quot;). If you must mark one approved, the following process can be used:</p>
<ul>
<li>ctrl-click on a point in the area that shall be &quot;correct&quot;.</li>
<li>follow along the two segment slices and place blue POIs at an interval wherever you are sure the trace follows the correct sheet.</li>
<li>place red POIs where errors occur. This process will place a &quot;cross&quot; of two lines which show the good/bad areas of the patch</li>
<li>ctrl-click to focus on a point on/between blue points to generate a second line, this way a whole grid of points is generated</li>
<li>use this grid as orientation to create a mask in GIMP</li>
</ul>
<p><strong>Masking</strong></p>
<p>By clicking on the &quot;edit segment mask&quot; button a mask image will be generated and saved as .tif in the segments directory. Then the systems default application for the filetype .tif will be launched. It is recommended to use GIMP for this. The mask file is a multi-layer tif file where the lowest layer is the actual binary mask and the second layer is the rendered surface using the currently selected volume.</p>
<ul>
<li>place one POI on one side of the jump and a second on the other.</li>
<li>select &quot;filter by POIs&quot; to get a list of patches which contain this sheet jump, this probably list about 5-20 patches</li>
<li>press &quot;edit segment mask&quot;</li>
<li>GIMP will open an import dialog, the default settings are fine so just press import</li>
<li>click on the layer transparency to make the upper layer around 50% transparent</li>
<li>your default tool should be the pencil tool with black as color and a size of around 30-100 pixels. Use it to mask out offending areas on the lower layer (the actual mask), refer back to VC3D if you are unsure.</li>
<li>save the mask by clicking &quot;File-&gt;overwrite mask.tif&quot;</li>
</ul>
<p>With this process a mask can be generated using less than 10 clicks</p>
<div class="mb-4"><img src="/img/segmentation/gimp_masking.jpg" class="w-[100%]"></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inpainting">Inpainting<a href="#inpainting" class="hash-link" aria-label="Direct link to Inpainting" title="Direct link to Inpainting">​</a></h3>
<p>It is possible after the previous steps to simply render the trace and use it within downstream tasks. The traces at this stage however frequently contain holes and are not flattened as well as they could be. To improve the mesh, we can combine multiple traces and attempt to fill in the holes.</p>
<p>The traces to be combined should be error free, and one can mask out bad regions of these larger traces using the same masking process as we used on the patches.</p>
<p><strong>Generating Winding Number Assignments</strong></p>
<div class="mb-4"><img src="/img/segmentation/wind_vis.png" class="w-[100%]"></div>
<p>The first step in the fusion process is generating relative winding numbers of each trace by running:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">OMP_WAIT_POLICY=PASSIVE OMP_NESTED=FALSE \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vc_tifxyz_winding /path/to/trace</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which will generate some debug images and the two files &quot;winding.tif&quot; and &quot;winding_vis.tif&quot;. Check the winding vis for errors, it should be a smooth continuous rainbow going from left to right. If you see discontinuities here, there were some errors in the trace that must be fixed. Mask those errors in the source trace and re-run winding estimation until it works. This should not generally be necessary.</p>
<p>Copy the winding.tif and wind_vis.tif to the traces storage directory so it&#x27;s all in one place and ready for the next step. The winding estimation should take about 10s.</p>
<p><strong>Trace Fusion and Inpainting</strong></p>
<p>Once you have estimated winding assignments for all the traces you intend on fusing, you can run this command with an arbitrary number of traces. Note that the first trace will be used as the seed and it will also define the size of the output trace and will generate normal constraints, so it should be the longest and most complete. The number after the trace is the weight of the trace when generating the surface, in all tests a weight of 1.0 was used and for the submission this params.json.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">OMP_WAIT_POLICY=PASSIVE OMP_NESTED=FALSE time nice \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vc_fill_quadmesh params.json /path/to/trace1/ /path/to/trace1/winding.tif 1.0 /path/to/trace2/ /path/to/trace2/winding.tif 1.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The params.json contains the following keys:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;trace_mul&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;dist_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;straight_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.005</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;surf_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.05</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;z_loc_loss_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.002</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;wind_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;wind_th&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;inpaint_back_range&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">60</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;opt_w&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Grounding and Upscaling</strong>
The output of this fusion process is a lower resolution than the source traces. To upscale it back to its source resolution, run the following command</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vc_tiffxyz_upscale_grounding &lt;infill-tiffxyz&gt; &lt;infill-winding&gt; 5 /path/to/trace1/ /path/to/trace1/winding.tif ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rendering">Rendering<a href="#rendering" class="hash-link" aria-label="Direct link to Rendering" title="Direct link to Rendering">​</a></h3>
<p>Each stage of the seeding/expanding/tracing process uses the tifxyz format, and thus any output in these processes can be rendered by using the <code>vc_render_tifxyz</code>. To render your new trace, enter:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">OMP_WAIT_POLICY=PASSIVE OMP_NESTED=FALSE time nice \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vc_render_tifxyz /path/to/volume/ome-zarr /output/path/%02d.tif /path/to/trace 0.5 1 21</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where 0.5 is the &quot;scale&quot; (the final output is scaled down to this percentage, 50% in the example), 1 is the source resolution group (in this case, 1 , or the second resolution of the ome-zarr), and 21 is the number of &quot;layers&quot; from the center slice we want, equally in positive and negative directions. This will generate 21 slices from our traditionally understood &quot;layer 22&quot; to &quot;layer 43&quot;.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For the TimeSFormer model, the &quot;1&quot; resolution performs only slightly worse than the full resolution, &quot;0&quot;. The i3d first letters model however, performs much worse on downsampled data. For models of this type, it is suggested to render the full resolution. This requires processing 8x more data, and will render significantly slower.</p></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ink-detection">Ink Detection<a href="#ink-detection" class="hash-link" aria-label="Direct link to Ink Detection" title="Direct link to Ink Detection">​</a></h3>
<p>Ink detection on the produced segmentations is no different at this stage than it was on previous segments, although some of the segmentations generated by the tracer can be quite large. The <a href="https://github.com/ScrollPrize/villa/tree/main/ink-detection" target="_blank" rel="noopener noreferrer">ink-detection</a> page of the villa monorepo contains the 2023 Grand-Prize model, with some recent updates. If you have difficulty loading large segmentations with this version, a fork exists which was used to generate the ink detections for @waldkauz and @bruniss 2024 year-end submission , documented <a href="https://discord.com/channels/1079907749569237093/1315006782191570975" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="mb-4"><img src="/img/segmentation/v4_hr.jpg" class="w-[100%]"><figcaption class="mt-[-6px]">2023 grand prize region trace and ink detection.</figcaption></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-issues">Common Issues<a href="#common-issues" class="hash-link" aria-label="Direct link to Common Issues" title="Direct link to Common Issues">​</a></h3>
<p><strong>When attempting to run one of these steps, you encounter &quot;json&quot; errors</strong></p>
<ul>
<li>Fix: 99% of the time when this error is thrown, it is the result of an incorrect path in the command, or a missing meta.json file in the target volume. Check your paths.</li>
</ul>
<div class="ml-8"><img src="/img/segmentation/json_error.png" class="w-[75%]"></div>
<p><strong>When running subsequent traces after an initial trace , a write error is thrown</strong></p>
<ul>
<li>Fix: The tracer cannot write to the folder because a folder with the same name exists. Clear your paths directory of &quot;z_dbg_gen&quot; files, and try again.</li>
</ul>
<p><strong>When attempting to run a trace on a verified existing seed patch, and no z_dbg_gen files exist, a permissions or write error is thrown</strong></p>
<ul>
<li>Fix: If you launched docker using sudo, your patches are owned by sudo and thus your user does not have permissions. Type <code>sudo chown -R username /path/to/paths/</code></li>
</ul>
<p><strong>Trace ends abruptly or before expected considering seed density</strong></p>
<ul>
<li>Fix: If you are running into issues getting your trace to &quot;take off&quot;, verify you are heading in the direction of a densely seeded region. If you are starting from the umbilicus or the outside of the scroll, verify you are not trying to trace outside of the volume. Change your <code>flip x:</code> key in the params.json.</li>
<li>Note: If you are sure your <code>flip x:</code> key is properly set, and still cannot get a trace to go from a good initial seed, you can try lowering the <code>step</code> parameter. This increases processing time significantly, but can help traces in regions of high curvature.</li>
</ul>
<p><strong>Cannot view zarr in VC3D gui (may just show a black screen), or cannot select it in the volumes drop-down</strong></p>
<ul>
<li>Fix: ensure that you have a meta.json in the zarr&#x27;s root, and that it contains <code>&quot;format&quot;:&quot;zarr&quot;</code></li>
<li>Ensure that the volume is in uint8, or <code>|u1</code> if looking at the <code>.zarray</code> file</li>
</ul>
<p><strong>Seed or Expand steps are running slow on VC3D built from source</strong></p>
<ul>
<li>Fix: on most ubuntu linux installations, at least one of two file indexers are typically installed -- <code>tracker-miner-fs</code> or <code>rygel</code>. Either of these will attempt to index every single file you add, and during the seed/expansion steps, this is a very large number. You will want to &quot;mask&quot; or disable these services, as they will slow the seed/expansion steps to a crawl.</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tips-and-tricks">Tips and Tricks<a href="#tips-and-tricks" class="hash-link" aria-label="Direct link to Tips and Tricks" title="Direct link to Tips and Tricks">​</a></h3>
<p><strong>&quot;Checkpointing&quot;</strong></p>
<p>If you are attempting to create very large traces, it is generally smart to &quot;checkpoint&quot; your progress as you go by running a relatively long trace, allowing it to continue through errors, and then utilizing your dbg_gen files as &quot;superpatches&quot;. The process looks like this:</p>
<ul>
<li>Run a trace</li>
<li>Starting from your longest one, identify large contiguous regions of papyrus without errors</li>
<li>Edit the mask, and remove all the areas other than this</li>
<li>Rename the folder to &quot;auto_grown_xxx&quot;</li>
<li>Update the meta.json with this new name</li>
<li>Run <code>vc_seg_add_overlap /path/to/paths /path/to/trace</code></li>
<li>Mark the segment as &quot;approved&quot; in the VC3D gui</li>
</ul>
<p><strong>Manual Seeding</strong></p>
<p>It can be highly beneficial to manually seed volumes. The random seeding is just that, random. It places seeds at nonzero points throughout the volume, and these points can include the case, the lining, or regions that are far from the current location you&#x27;re targeting. If you wish to manually seed, simply open the volume in VC3D, the simplest way is likely the following:</p>
<ul>
<li>ctrl+click on the predicted surfaces around the area you&#x27;re trying to segment. Ensure you don&#x27;t miss any sheets. As you click these points, the 3d coordinates will be printed into the terminal.</li>
<li>Copy the script below and paste it into a file called <code>create_seed.sh</code>, changing the paths to your own</li>
<li>Run this script from a separate terminal</li>
<li>Paste the outputs of the coordinates (including the words before them) into the terminal running <code>create_seed</code></li>
<li>The script will run vc_grow_seg_from_segments in explicit seed mode at these locations</li>
<li>Verify that a seed has been created on each surface around the target region, and that none have been missed</li>
<li>If necessary, repeat the process until you have a seed on each wrap.</li>
<li>Run vc_grow_seg_from_seed in expansion mode as detailed earlier in the tutorial</li>
</ul>
<p>The primary motivation for doing this is that if you run expansion mode on randomly created seeds, a significant portion of your compute time is spent expanding seeds into regions you might not care about, or expanding seeds along the case. While it&#x27;s generally true that if you leave expansion mode running long enough, it will fill the volume, this may take a while. It is also not possible for a seed to expand if the surface itself is not sufficiently connected to other surfaces -- it is not uncommon to miss large parts of wraps if you do not verify and manually seed.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Configuration variables - update these as needed:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">OME_ZARR_VOLUME=&quot;/home/sean/Documents/volpkgs/scroll3.volpkg/volumes/s3_059_medial_ome.zarr/&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TGT_DIR=&quot;/home/sean/Documents/volpkgs/scroll3.volpkg/paths/&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">JSON_PARAMS=&quot;/home/sean/Documents/volpkgs/scroll3.volpkg/seed.json&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CMD=&quot;bin/vc_grow_seg_from_seed&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Offset variable (in voxels)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">OFFSET=30</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Maximum number of parallel jobs to run concurrently</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">MAX_JOBS=16</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Check for bc availability. If not available, fallback to awk.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if command -v bc &gt;/dev/null 2&gt;&amp;1; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    use_bc=1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    echo &quot;bc command not found. Falling back to awk for arithmetic.&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    use_bc=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Function to wait until background jobs are below MAX_JOBS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wait_for_slot() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    while [ &quot;$(jobs -r | wc -l)&quot; -ge &quot;$MAX_JOBS&quot; ]; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sleep 0.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">while true; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    echo &quot;Paste coordinate lines (end with an empty line):&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lines=()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    while IFS= read -r line; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        [[ -z &quot;$line&quot; ]] &amp;&amp; break</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        lines+=(&quot;$line&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if [ ${#lines[@]} -eq 0 ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo &quot;No coordinates provided. Try again.&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        continue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Process each pasted line</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for line in &quot;${lines[@]}&quot;; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # Extract text between [ and ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        coords=$(echo &quot;$line&quot; | grep -o &#x27;\[[^]]*\]&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if [ -z &quot;$coords&quot; ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            echo &quot;No coordinates found in: $line&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            continue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # Remove the square brackets and split into x, y, z</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        coords=${coords#[}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        coords=${coords%]}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        IFS=&#x27;,&#x27; read -r x y z &lt;&lt;&lt; &quot;$coords&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        x=$(echo &quot;$x&quot; | xargs)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        y=$(echo &quot;$y&quot; | xargs)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        z=$(echo &quot;$z&quot; | xargs)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo &quot;Processing coordinate: x=$x, y=$y, z=$z&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        # Loop only over x offsets: -OFFSET, 0, and +OFFSET</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for dx in -$OFFSET 0 $OFFSET; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # Ensure we don&#x27;t exceed the parallel job limit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            wait_for_slot</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            # Calculate new seed position for x; y and z remain unchanged.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if [ $use_bc -eq 1 ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seed_x=$(echo &quot;$x + $dx&quot; | bc)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                seed_x=$(awk &quot;BEGIN {print $x + $dx}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            seed_y=$y</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            seed_z=$z</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            echo &quot;Launching: nice ionice $CMD $OME_ZARR_VOLUME $TGT_DIR $JSON_PARAMS $seed_x $seed_y $seed_z&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            nice ionice $CMD &quot;$OME_ZARR_VOLUME&quot; &quot;$TGT_DIR&quot; &quot;$JSON_PARAMS&quot; &quot;$seed_x&quot; &quot;$seed_y&quot; &quot;$seed_z&quot; || true &amp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        done</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Wait for all background jobs to finish before prompting again</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    wait</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    echo &quot;Finished processing these coordinates.&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    echo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">done</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spiral-fitting-coming-soon">Spiral Fitting (Coming Soon)<a href="#spiral-fitting-coming-soon" class="hash-link" aria-label="Direct link to Spiral Fitting (Coming Soon)" title="Direct link to Spiral Fitting (Coming Soon)">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ScrollPrize/villa/tree/main/scrollprize.org/docs/35_segmentation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Overview</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/deepast/get_started">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Deep Past Challenge.</div></div></div></footer></div>
</body>
</html>